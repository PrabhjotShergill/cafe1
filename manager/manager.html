<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cafe QuickBite - Manager Dashboard</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <style>
    body { background: #f7f7f7; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
    .manager-header {
      padding: 18px 40px;
      background: #fff;
      font-size: 2rem;
      font-weight: bold;
      border-bottom: 1px solid #e9e9e9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .manager-header .highlight { color: #8bc34a; }
    .dashboard-container {
      max-width: 950px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 1px 16px rgba(80,80,80,0.07);
    }
    h2 { margin-bottom: 20px; font-weight: 600; color: #333; }
    .section { margin-bottom: 38px; }
    table { width: 100%; border-collapse: collapse; font-size: 1rem; }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      text-align: left;
    }
    th {
      background: #f3fbe7;
      color: #79a144;
    }
    button {
      background: #8bc34a;
      border: none;
      color: white;
      padding: 9px 16px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 7px;
      margin-top: 12px;
    }
    button:hover { background: #689f38; }
    select {
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 1rem;
      border: 1px solid #aaa;
      font-weight: 600;
      color: #3b3b3b;
    }
    .alert-low { color: #c62828; font-weight: 700; }
  </style>
</head>
<body>
  <header class="manager-header">
    Cafe QuickBite <span class="highlight">Manager</span> Dashboard
  </header>

  <div class="dashboard-container">
    <div class="section">
     <h2>Reports</h2>
<label>Start Date: <input type="date" id="startDate" /></label>
<label style="margin-left:20px;">End Date: <input type="date" id="endDate" /></label>
<br><br>
<button onclick="generateReport()">Generate Report</button>
<p><strong>Total Sales:</strong> ₹<span id="salesTotal">0</span></p>
<p><strong>Orders Processed:</strong> <span id="ordersCount">0</span></p>
<p><strong>Unique Customers:</strong> <span id="customerCount">0</span></p>
<p><strong>Last Updated:</strong> <span id="reportTime">-</span></p>
<p id="reportMsg" style="margin-top:10px; color:green;"></p>
    </div>

    <div class="section">
      <h2>Manage Staff</h2>
      <table id="staffTable">
        <thead><tr><th>Name</th><th>Role</th><th>Assign Role</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Inventory Monitoring</h2>
      <table id="inventoryTable">
        <thead><tr><th>Item</th><th>Stock</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
      <button onclick="checkLowStock()">Check Low Stock Alerts</button>
    </div>
  </div>

  <script>
    const staffApi = 'http://localhost:3000/staff';
    const reportApi = 'http://localhost:3000/reports/1';
    const inventoryApi = 'http://localhost:3000/inventory';
    const roles = ['Cashier', 'Kitchen', 'Waiter', 'Inventory', 'Manager'];

    let staff = [], inventory = [];

    async function fetchStaff() {
      const res = await fetch(staffApi);
      staff = await res.json();
      renderStaff();
    }

    function renderStaff() {
      const tbody = document.querySelector('#staffTable tbody');
      tbody.innerHTML = '';
      staff.forEach((s, idx) => {
        const tr = document.createElement('tr');
        const sel = document.createElement('select');
        roles.forEach(role => {
          const opt = document.createElement('option');
          opt.value = role;
          opt.textContent = role;
          if (role === s.role) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.onchange = () => assignRole(s.id, sel.value);
        tr.innerHTML = `<td>${s.name}</td><td>${s.role}</td><td></td>`;
        tr.children[2].appendChild(sel);
        tbody.appendChild(tr);
      });
    }

    async function assignRole(id, newRole) {
      await fetch(`${staffApi}/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: newRole })
      });
      fetchStaff();
    }

    async function loadReport() {
      const res = await fetch(reportApi);
      if (!res.ok) return;
      const report = await res.json();
      document.getElementById('salesTotal').innerText = report.sales;
      document.getElementById('ordersCount').innerText = report.orders;
      document.getElementById('reportTime').innerText = new Date(report.lastUpdated).toLocaleString();
    }

   const ordersApi = 'http://localhost:3000/orders';

async function generateReport() {
  const startInput = document.getElementById('startDate').value;
  const endInput = document.getElementById('endDate').value;

  if (!startInput || !endInput) {
    alert('Please select both start and end dates.');
    return;
  }

  const startDate = new Date(startInput);
  const endDate = new Date(endInput);
  endDate.setHours(23, 59, 59, 999); // include full end day

  const res = await fetch(ordersApi);
  const allOrders = await res.json();

  const filtered = allOrders.filter(order => {
    const orderTime = new Date(order.time);
    return orderTime >= startDate && orderTime <= endDate;
  });

  const totalSales = filtered.reduce((sum, o) => sum + o.total, 0);
  const uniqueCustomers = new Set(filtered.map(o => o.customerPhone));
  const timestamp = new Date().toISOString();

  document.getElementById('salesTotal').innerText = totalSales;
  document.getElementById('ordersCount').innerText = filtered.length;
  document.getElementById('customerCount').innerText = uniqueCustomers.size;
  document.getElementById('reportTime').innerText = new Date(timestamp).toLocaleString();
  document.getElementById('reportMsg').innerText = 'Report generated successfully!';
  setTimeout(() => document.getElementById('reportMsg').innerText = '', 9000);
}

    async function fetchInventory() {
      const res = await fetch(inventoryApi);
      inventory = await res.json();
      renderInventory();
    }

    function renderInventory() {
      const tbody = document.querySelector('#inventoryTable tbody');
      tbody.innerHTML = '';
      inventory.forEach(item => {
        const status = item.stock < 10 ? 'Low Stock' : 'Sufficient';
        const statusClass = item.stock < 10 ? 'alert-low' : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.name}</td><td>${item.stock}</td><td class="${statusClass}">${status}</td>`;
        tbody.appendChild(tr);
      });
    }

    function checkLowStock() {
      const lowItems = inventory.filter(i => i.stock < 10);
      if (lowItems.length === 0) {
        alert('No low stock items at the moment.');
      } else {
        const msg = 'Low stock alert for:\n' + lowItems.map(i => `• ${i.name} — Stock: ${i.stock}`).join('\n');
        alert(msg);
      }
    }

    fetchStaff();
    loadReport();
    fetchInventory();
  </script>
</body>
</html>