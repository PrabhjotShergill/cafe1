<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuickBite Cafe - Cashier Panel</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <style>
    body {
      background: #f7f7f7;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }
    .cashier-header {
      padding: 18px 40px;
      background: #fff;
      font-size: 2rem;
      font-weight: bold;
      border-bottom: 1px solid #e9e9e9;
    }
    .cashier-header .highlight {
      color: #8bc34a;
    }
    .cashier-container {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 1px 12px rgba(80,80,80,0.05);
    }
    h2 {
      margin-bottom: 20px;
      font-weight: 600;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      text-align: center;
    }
    th {
      background: #f3fbe7;
      color: #79a144;
    }
    .status-paid {
      color: #4caf50;
      font-weight: bold;
    }
    .status-unpaid {
      color: #e65100;
      font-weight: bold;
    }
    .payment-form {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .payment-form select {
      padding: 6px;
      border-radius: 6px;
      font-weight: 600;
    }
    .payment-form button {
      background: #8bc34a;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    .payment-form button:hover {
      background: #689f38;
    }
  </style>
</head>
<body>
  <div class="cashier-header">
    QuickBite <span class="highlight">Cafe</span> Cashier
  </div>

  <div class="cashier-container">
    <h2>Customer Orders</h2>
    <table id="orderTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Items</th>
          <th>Total</th>
          <th>GST (5%)</th>
          <th>Grand Total</th>
          <th>Status</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const orderApi = 'http://localhost:3000/orders';
    const salesApi = 'http://localhost:3000/sales';
    let orders = [];

    async function fetchOrders() {
      const res = await fetch(orderApi);
      orders = await res.json();
      renderOrders();
    }

    function renderOrders() {
      const tbody = document.querySelector('#orderTable tbody');
      tbody.innerHTML = '';
      orders.forEach(order => {
        const itemsList = order.items.map(i => `${i.name} x${i.qty}`).join(', ');
        const gst = Math.round(order.total * 0.05);
        const grandTotal = order.total + gst;
        const statusClass = order.method === 'Paid' ? 'status-paid' : 'status-unpaid';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.orderId}</td>
          <td>${order.customerName}</td>
          <td>${order.customerPhone}</td>
          <td>${itemsList}</td>
          <td>₹${order.total}</td>
          <td>₹${gst}</td>
          <td>₹${grandTotal}</td>
          <td class="${statusClass}">${order.method || 'Unpaid'}</td>
          <td>
            ${order.method === 'Paid'
              ? '—'
              : `
                <div class="payment-form">
                  <select id="payMethod${order.id}">
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="UPI">UPI</option>
                  </select>
                  <button onclick="processPayment(${order.id}, ${gst}, ${grandTotal})">Pay</button>
                </div>
              `}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function processPayment(orderId, gst, grandTotal) {
      const method = document.getElementById(`payMethod${orderId}`).value;
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      await fetch(`${orderApi}/${orderId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method: 'Paid', status: 'Completed' })
      });

      const saleData = {
        orderId: order.orderId,
        customerName: order.customerName,
        customerPhone: order.customerPhone,
        items: order.items,
        baseTotal: order.total,
        gst,
        grandTotal,
        paymentMethod: method,
        time: new Date().toISOString()
      };

      await fetch(salesApi, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saleData)
      });

      const billWindow = window.open('', '', 'width=600,height=600');
      billWindow.document.write(`
  <html>
    <head><title>QuickBite Bill</title></head>
    <body onload="window.print()">
      <h2>QuickBite Cafe - Bill</h2>
      <p><strong>Order ID:</strong> ${order.orderId}</p>
      <p><strong>Customer:</strong> ${order.customerName}</p>
      <p><strong>Phone:</strong> ${order.customerPhone}</p>
      <p><strong>Items:</strong> ${order.items.map(i => `${i.name} x${i.qty}`).join(', ')}</p>
      <p><strong>Base Total:</strong> ₹${order.total}</p>
      <p><strong>GST (5%):</strong> ₹${gst}</p>
      <p><strong>Grand Total:</strong> ₹${grandTotal}</p>
      <p><strong>Payment Method:</strong> ${method}</p>
      <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
      <hr><p>Thank you for dining with us!</p>
    </body>
  </html>
`);
billWindow.document.close();
setTimeout(fetchOrders, 1000);
  </script>
</body>
</html>